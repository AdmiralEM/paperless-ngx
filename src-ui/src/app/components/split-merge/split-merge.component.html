<app-page-header i18n-title title="Split & Merge Editor">
  <div class="btn-group mr-5">
    <button class="btn btn-sm btn-outline-danger" i18n-title title="Cancel" (click)="cancel()">
      <svg width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor">
        <use xlink:href="assets/bootstrap-icons.svg#slash-circle" />
      </svg>&nbsp;<ng-container i18n>Cancel</ng-container>
    </button>
  </div>

  <div class="btn-group ml-5">
    <button type="button" class="btn btn-sm btn-outline-primary"
      [popoverTitle]="optionsTitle" [autoClose]="'outside'" [ngbPopover]="optionsPopoverBody" popoverclass="shadow" #optionsPopover="ngbPopover">
      <svg width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor">
        <use xlink:href="assets/bootstrap-icons.svg#gear" />
      </svg>&nbsp;<ng-container i18n>Options</ng-container>
    </button>
    <ng-template #optionsTitle>
      <ng-container i18n>Options</ng-container>
      <button type="button" class="close" aria-label="Close" (click)="optionsPopover.close()">
        <span aria-hidden="true">&times;</span>
      </button>
    </ng-template>
    <ng-template #optionsPopoverBody>
      <div class="form-group row text-light">
        <label for="source_options" class="col-sm-3 col-form-label pt-0" i18n>Delete source documents</label>
        <div class="col-sm-9">
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="source_options-delete" [(ngModel)]="delete_source_documents">
            <label class="custom-control-label" for="source_options-delete"><ng-container i18n>Delete</ng-container><br/><small [class.text-muted]="!delete_source_documents" [class.text-danger]="delete_source_documents" i18n>Source documents will be immediately deleted.</small></label>
          </div>
        </div>
      </div>
      <div class="form-group mt-4 row text-light">
        <label for="metadata_options" class="col-sm-3 col-form-label pt-0" i18n>Output document metadata</label>
        <div class="col-sm-9">
          <div class="custom-control custom-radio">
            <input type="radio" id="metadata_setting-copy" name="metadata_setting" class="custom-control-input" [value]="splitMergeMetadata.COPY_FIRST" [(ngModel)]="metadata_setting">
            <label class="custom-control-label" for="metadata_setting-copy"><ng-container i18n>First document</ng-container><br/><small class="text-muted" i18n>Metadata will be copied from first document.</small></label>
          </div>
          <div class="custom-control custom-radio">
            <input type="radio" id="metadata_setting-redo" name="metadata_setting" class="custom-control-input" [value]="splitMergeMetadata.REDO" [(ngModel)]="metadata_setting">
            <label class="custom-control-label" for="metadata_setting-redo"><ng-container i18n>Redo</ng-container><br/><small class="text-muted" i18n>Metadata detection will be re-run on new document.</small></label>
          </div>
        </div>
      </div>
    </ng-template>
  </div>

  <div class="btn-group ml-3">
    <button class="btn btn-sm btn-outline-primary" i18n-title title="Save" (click)="save()" [disabled]="splitMergeService.getDocuments().length < 1">
      <svg width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor">
        <use xlink:href="assets/bootstrap-icons.svg#check-circle" />
      </svg>&nbsp;<ng-container i18n>Save</ng-container>
    </button>
  </div>
</app-page-header>

<div class="row">
  <div class="col-lg-6">
    <div class="btn-toolbar" role="toolbar">
      <button class="btn btn-sm btn-outline-primary w-100" i18n-title title="Add Documents" (click)="chooseDocuments()">
        <svg width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor">
          <use xlink:href="assets/bootstrap-icons.svg#plus-circle" />
        </svg>&nbsp;<ng-container i18n>Add Documents</ng-container>
      </button>
    </div>
    <div class="py-4" dndDropzone (dndDrop)="onDrop($event, documents)">
      <div class="spacer bg-primary" dndPlaceholderRef>
      </div>
      <div *ngFor="let d of documents; let i = index" class="card w-100 mb-3" [class.separator-card]="d.is_separator" [dndDraggable]="d" dndEffectAllowed="move" (dndMoved)="onDragged(d, documents)">
        <ng-container *ngIf="d.is_separator">
          <div class="separator"></div>
          <h6 class="text-muted small font-weight-bold d-inline-block pt-2 px-3 mb-2 mx-auto bg-body" i18n>Document End</h6>
          <button class="btn btn-sm btn-danger" title="Remove" (click)="removeDocument(d, i)">
            <svg width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor">
              <use xlink:href="assets/bootstrap-icons.svg#trash" />
            </svg>
          </button>
        </ng-container>
        <div *ngIf="!d.is_separator" class="row no-gutters">
          <div class="col-md-3 d-flex handle" dndHandle>
            <svg width="2em" height="100%" viewBox="0 0 16 16" fill="currentColor" class="mx-auto">
              <use xlink:href="assets/bootstrap-icons.svg#grip-horizontal" />
            </svg>
            <div class="doc-thumb" [style.background-image]="'url(' + getThumbUrl(d.id) + ')'"></div>
          </div>
          <div class="col-md-9">
            <div class="card-body p-3">
              <h6 class="card-title mb-2">{{d.title}}</h6>
              <div class="card-actions">
                <div class="btn-toolbar btn-toolbar-sm justify-content-between w-100">
                  <button class="btn btn-sm btn-outline-danger flex-fill" i18n-title title="Remove" (click)="removeDocument(d, i)">
                    <svg width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor">
                      <use xlink:href="assets/bootstrap-icons.svg#trash" />
                    </svg><span class="d-none d-xl-inline">&nbsp;<ng-container i18n>Remove</ng-container></span>
                  </button>
                  <button class="btn btn-sm btn-outline-primary ml-2 flex-fill" i18n-title title="Split" (click)="chooseSplit(d, i)">
                    <svg width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor">
                      <use xlink:href="assets/bootstrap-icons.svg#scissors" />
                    </svg><span class="d-none d-xl-inline">&nbsp;<ng-container i18n>Split</ng-container></span>
                  </button>
                </div>
                <div class="input-group input-group-sm w-100 mt-2">
                  <div class="input-group-prepend">
                    <div class="input-group-text"><ng-container i18n>Pages</ng-container>:</div>
                  </div>
                  <app-input-debounce delay="500" classes="form-control-sm" placeholder="All" ngbTooltip="e.g. 1-3,5" [inputValue]="formatPages(d.pages)" (value)="pagesFieldChange($event, d, i)"></app-input-debounce>
                  <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" i18n-title title="Clear" [disabled]="d.pages?.length < 1" (click)="clearPages(d, i)">
                      <svg width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor">
                        <use xlink:href="assets/bootstrap-icons.svg#x" />
                      </svg>
                    </button>
                    <button class="btn btn-outline-primary" type="button" i18n-title title="Select Pages" (click)="choosePages(d, i)">
                      <svg width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor">
                        <use xlink:href="assets/bootstrap-icons.svg#pencil" />
                      </svg><span class="d-none d-xl-inline">&nbsp;<ng-container i18n>Select Pages</ng-container></span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <ng-container *ngIf="previewUrls.length > 1">
      <ul ngbNav #previewNav="ngbNav" class="nav-tabs">
        <li *ngFor="let previewUrl of previewUrls; let j = index" [ngbNavItem]="j">
          <a class="bg-light" ngbNavLink><ng-container i18n>Document</ng-container> {{j + 1}}</a>
          <ng-template ngbNavContent>
            <div class="preview-container tabbed text-center bg-light">
              <h6 class="my-2 text-muted" i18n>Preview</h6>
              <div *ngIf="loading" class="spinner-border" role="status">
                <span class="sr-only" i18n>Loading...</span>
              </div>
              <pdf-viewer [src]="previewUrl" [original-size]="false" [show-borders]="true" [show-all]="true" [render-text-mode]="2" (after-load-complete)="pdfPreviewLoaded($event)"></pdf-viewer>
            </div>
          </ng-template>
        </li>
      </ul>
      <div [ngbNavOutlet]="previewNav"></div>
    </ng-container>
    <div *ngIf="previewUrls.length <= 1" class="preview-container text-center bg-light">
      <h6 class="my-2 text-muted" i18n>Preview</h6>
      <div *ngIf="loading" class="spinner-border" role="status">
        <span class="sr-only" i18n>Loading...</span>
      </div>
      <pdf-viewer *ngIf="previewUrls.length > 0" [src]="previewUrls[0]" [original-size]="false" [show-borders]="true" [show-all]="true" [render-text-mode]="2" (after-load-complete)="pdfPreviewLoaded($event)"></pdf-viewer>
    </div>
  </div>
</div>
